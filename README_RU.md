# Kinozal-Bot

Цель проекта:

- Генерация новых постов с отправкой в Telegram канал на основе новых публикаций в трекере **[Кинозал](https://kinozal.tv)** с фильтрацией по рейтингу и году выхода.
- Автоматизация процесса донесения контента до телевизора используя только телефон. Выбор (предложенного из поста канала или при ручном поиске в боте) и загрузка подходящего по разрешению, озвучке или размеру торрент-файла (используя предложенные рекомендуемые ссылки к каждой публикации), постановка на загрузку в qBittorrent с возможностью управления и отслеживанием статуса а так же изменением приоритета загрузки файлов, и синхронизации контента с Plex Media Server.

### Stack

- **Kinozal**: чтение RSS ленты, получение данных из html (api отсутствует), поиск и фильтрация контента, загрузка торрент файлов;
- Опционально: любое клиентское приложение VPN и прокси сервер для доступа в Кинозал;
- **Telegram api**: отправка сообщений в канал, чтение (только команд) и отправка ответных сообщений в формате меню (keyboard);
- **qBittorrent api**: загрузка данных и торрент файлов и управление данными (пауза, удаление, изменение приоритета);
- **Plex Media Server api**: синхронизация данных и получение информации о содержимом секций и дочерних файлах.

* Планируется добавить получение дополнительной информации используя стороннее api (например, tmdb или videocdn) и размера диска (например, Open Hardware Monitor через web api).

### Example

Выбор и поиск раздачи, загрузка торрент файла и постановка на загрузку в qBittorrent:



Управление контентом и синхронизация с Plex:



### Install

Все настройки задаются в конфигурационном файле: **kinozal-bot.conf**.

1. Зарегистрировать аккаунт в **Кинозал** и заполнить параметры в конфигурации:

`KZ_PROFILE="id_you_profile"` - используется для получения информации из профиля \
`KZ_USER="LOGIN"` - используется на этапе загрузки торрент-файла и получения информации в профиле \
`KZ_PASS="PASSWORD"`

1.1. Если у вас нет прямого доступа в Кинзон, можете воспользоваться VPN или прокси сервером (я использую **Handy Cache** в связке с **VPN Hotspot Shield** в режиме Split Tunneling на ОС Windows) через который бот сможет проксировать свои запросы.

`PROXY="True"` - включить использование прокси сервера в curl-запросах при обращении к Кинозал \
`PROXY_ADDR="http://192.168.3.100:9090"` \
`PROXY_USER="LOGIN"` \
`PROXY_PASS="PASSWORD"`

2. Установить торрент клиент **qBittorrent**, в настройках включить **Веб-интерфейс**.

`QB_ADDR="http://192.168.3.100:8888"` - указать IP-адрес машины, на которой запущен qBittorrent и порт, который указан в настройках \
`QB_USER="LOGIN"` - указывается в поле **Аутентификация** в настройках **Веб-интерфейс** \
`QB_PASS="PASSWORD"`

![Image alt](https://github.com/Lifailon/Kinozal-Bot/blob/rsa/image/qbittorrent-settings.jpg)

3. Установить **Plex Media Server** (в моем случае установлен там же, где клиент qBittorrent на машине с ОС Windows) и **получить ключ/токен** для доступа к REST API. Я не нашел способа получить ключ в веб-интерфейсе, по этому при авторизации перехватил токен в url-запросе сетевого журнала (X-Plex-Token=), используя **Development Tools** (нет ограничения по времени).

`PLEX_ADDR="http://192.168.3.100:32400"` \
`PLEX_TOKEN="TOKEN"`

![Image alt](https://github.com/Lifailon/Kinozal-Bot/blob/rsa/image/plex-token.jpg)

4. Для запуска бота расположите конфигурационный файл **kinozal-bot.conf** рядом со скриптом (пути хранения лог-файла, куки и торрент файлов задаются в конфигурации) и используйте интерпритатор для запуска (root права не требуются):

`bash ~/bash kinozal-torrent/kinozal-bot-0.4.sh`

При запуске, будет указан путь к журналу. Всего запусается 2 основных потока (процесса) и до 20 дочерних в процессе работы.

**Остановить сервис:**

`bash ~/bash kinozal-torrent/kinozal-bot-0.4.sh stop`

`bash ~/bash kinozal-torrent/kinozal-bot-0.4.sh status`
